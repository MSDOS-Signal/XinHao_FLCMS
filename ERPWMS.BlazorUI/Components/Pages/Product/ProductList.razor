@page "/products"
@using ERPWMS.Domain.Entities
@using ERPWMS.Infrastructure.Persistence
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>äº§å“ç®¡ç†</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h1>ğŸ“¦ äº§å“åº“ç®¡ç† (WMSæ ¸å¿ƒ)</h1>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" @onclick="CreateProduct">
                <i class="bi bi-plus-lg"></i> æ–°å¢äº§å“
            </button>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>æ“ä½œå¼‚å¸¸ï¼š</strong> @errorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (products == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            æ­£åœ¨åŠ è½½æ•°æ®...
        </div>
    }
    else if (!products.Any())
    {
        <div class="alert alert-warning">æš‚æ— äº§å“æ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å¢ã€‚</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-hover table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>ç¼–ç </th>
                            <th>åç§°</th>
                            <th>ä»·æ ¼</th>
                            <th>æè¿°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in products)
                        {
                            <tr>
                                <td><span class="badge bg-secondary">@item.Code</span></td>
                                <td class="fw-bold">@item.Name</td>
                                <td class="text-success">Â¥@item.Price.ToString("N2")</td>
                                <td>@item.Description</td>
                                <td>@item.CreatedTime.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProduct(item)">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Product>? products;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try 
        {
            errorMessage = null;
            products = await DbContext.Products
                .OrderByDescending(p => p.CreatedTime)
                .AsNoTracking()
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"æ•°æ®åŠ è½½å¤±è´¥: {ex.Message} (è¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥æˆ–æ˜¯å¦å·²æ‰§è¡Œè¿ç§»)";
            Console.WriteLine(ex.ToString());
        }
    }

    private async Task CreateProduct()
    {
        try
        {
            // æ¨¡æ‹Ÿå¿«é€Ÿåˆ›å»º
            var newProduct = new Product
            {
                Name = $"ç¤ºä¾‹äº§å“-{DateTime.Now.ToString("HHmmss")}",
                Code = $"P{DateTime.Now.Ticks.ToString().Substring(10)}",
                Price = new Random().Next(100, 1000),
                Description = "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•æ•°æ®",
                CreatedBy = "Admin"
            };

            DbContext.Products.Add(newProduct);
            await DbContext.SaveChangesAsync();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"åˆ›å»ºå¤±è´¥: {ex.Message}";
        }
    }

    private async Task DeleteProduct(Product product)
    {
        try
        {
            DbContext.Products.Remove(product);
            await DbContext.SaveChangesAsync();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"åˆ é™¤å¤±è´¥: {ex.Message}";
        }
    }
}
