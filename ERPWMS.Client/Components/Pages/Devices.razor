@page "/devices"
@inject DeviceService DeviceService
@implements IDisposable

<h3 class="mb-3">SCADA 设备实时监控</h3>

@if (devices == null)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var device in devices)
        {
            <div class="col">
                <div class="card h-100 shadow @GetCardBorderClass(device.Status)">
                    <div class="card-header d-flex justify-content-between align-items-center @GetHeaderClass(device.Status) text-white">
                        <span class="fw-bold"><i class="bi bi-cpu"></i> @device.DeviceName</span>
                        <span class="badge bg-light text-dark font-monospace">@device.DeviceCode</span>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4 mt-2">
                            <i class="bi @GetIconClass(device.Status)" style="font-size: 3.5rem; color: @GetColor(device.Status)"></i>
                            <h4 class="mt-3 fw-bold" style="color: @GetColor(device.Status)">@TranslateStatus(device.Status)</h4>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(device.LastAlarmMessage) && device.Status == "Error")
                        {
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i> @device.LastAlarmMessage
                            </div>
                        }

                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <strong>IP 地址:</strong> 
                                <span class="font-monospace">@device.IpAddress</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <strong>最后心跳:</strong> 
                                <span class="font-monospace @(device.Status == "Running" ? "text-success" : "text-muted")">
                                    @(device.Status == "Running" ? device.LastActiveTime.ToString("HH:mm:ss") : "-")
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer bg-transparent border-top-0 pb-3">
                        <div class="d-grid gap-2">
                            @if (device.Status == "Running")
                            {
                                <button class="btn btn-outline-danger" @onclick='() => ToggleStatus(device, "Stopped")'>
                                    <i class="bi bi-stop-circle"></i> 停止运行
                                </button>
                            }
                            else if (device.Status == "Stopped")
                            {
                                <button class="btn btn-outline-success" @onclick='() => ToggleStatus(device, "Running")'>
                                    <i class="bi bi-play-circle"></i> 启动设备
                                </button>
                            }
                            else if (device.Status == "Error")
                            {
                                <button class="btn btn-warning text-white" @onclick="() => ResetAlarm(device)">
                                    <i class="bi bi-wrench-adjustable"></i> 复位报警
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<ERPWMS.Domain.Entities.Device>? devices;
    private System.Threading.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadDevices();
        // 启动模拟定时器
        timer = new System.Threading.Timer(async _ => await SimulateRealTimeData(), null, 1000, 2000);
    }

    private async Task LoadDevices()
    {
        devices = await DeviceService.GetAllAsync();
    }

    private async Task SimulateRealTimeData()
    {
        if (devices == null) return;

        foreach (var device in devices)
        {
            if (device.Status == "Running")
            {
                // 只有运行中的设备才更新心跳
                device.LastActiveTime = DateTime.Now;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task ToggleStatus(ERPWMS.Domain.Entities.Device device, string status)
    {
        if (await DeviceService.ToggleStatusAsync(device.Id, status))
        {
            device.Status = status; // 立即更新 UI
            await LoadDevices();
        }
    }

    private async Task ResetAlarm(ERPWMS.Domain.Entities.Device device)
    {
        if (await DeviceService.ResetAlarmAsync(device.Id))
        {
            await LoadDevices();
        }
    }

    private string GetCardBorderClass(string status) => status switch
    {
        "Running" => "border-success",
        "Error" => "border-danger",
        _ => "border-secondary"
    };

    private string GetHeaderClass(string status) => status switch
    {
        "Running" => "bg-success",
        "Error" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetIconClass(string status) => status switch
    {
        "Running" => "bi-gear-wide-connected fa-spin", // Note: fa-spin works if FontAwesome is present, otherwise simple icon
        "Error" => "bi-exclamation-octagon-fill",
        _ => "bi-pause-circle-fill"
    };

    private string GetColor(string status) => status switch
    {
        "Running" => "#198754",
        "Error" => "#dc3545",
        _ => "#6c757d"
    };

    private string TranslateStatus(string status) => status switch
    {
        "Running" => "运行中",
        "Stopped" => "已停止",
        "Error" => "故障报警",
        _ => status
    };

    public void Dispose()
    {
        timer?.Dispose();
    }
}
